# CI/CD Workflow: Полное описание и инструкция

## Что это такое

Данный CI/CD пайплайн реализует **автоматическую проверку качества кода, сборку и тестирование** для проектов на Kotlin/Gradle, с учетом best practices корпоративной разработки.
Используется инфраструктура **GitHub Actions**.
Пайплайн построен максимально модульно и прозрачно — каждый тип проверки (MR-нейминг, линтер, статический анализ, орфография, сборка, тесты) выделен в отдельный job, что облегчает масштабирование, сопровождение и поиск проблем.

---

## Как это работает

1. **Проверка названия Pull Request**

    * MR (Pull Request) должен быть назван по шаблону:
      `<area> | <module> | <type> | #<issue> - <description>`
      Пример:

      ```
      backend | user-auth | feature | #1234 - implement JWT login
      ```
    * Если имя не соответствует шаблону — MR не проходит автоматические проверки.

2. **Синхронизация исходников**

    * После успешной валидации MR-кода, текущее состояние репозитория архивируется как артефакт (`source`), который передается во все остальные проверки. Это исключает “рассинхрон” между этапами.

3. **Параллельные проверки качества**

    * **Линтер (`ktlint`)**: Проверка стиля и оформления кода.
    * **Статический анализ (`detekt`)**: Поиск потенциальных ошибок и smell-ов.
    * **Проверка орфографии (`yaspeller`)**: Русский и английский языки для `.kt`, `.kts`, `.md`, `.txt`.
    * Все проверки идут параллельно, и если любая не пройдена — дальнейшая сборка невозможна.

4. **Сборка и тесты**

    * После всех успешных проверок начинается сборка (`./gradlew build`), артефакты сборки сохраняются для последующих этапов.
    * Прогоняются все тесты (`./gradlew test`) — как unit, так и интеграционные.

5. **Соблюдаются best practices:**

    * Модульность: каждый этап — отдельный job.
    * DRY: shared-setup (общие шаги, такие как установка JDK, checkout и т.п.) вынесены в [composite action](https://docs.github.com/en/actions/creating-actions/creating-a-composite-action).
    * Синхронизация: все этапы работают с одним и тем же состоянием исходного кода.
    * Максимальная гибкость: легко добавить генерацию документации, деплой, публикацию в registry и другие шаги.

---

## Что нужно, чтобы заработало на проекте

1. **Структура репозитория:**

   ```
   .
   ├── .github/
   │   ├── actions/
   │   │   └── shared-setup/
   │   │       └── action.yml
   │   └── workflows/
   │       └── ci.yml
   ├── build.gradle.kts
   └── src/
   ```

2. **Обязательные файлы и плагины:**

    * Kotlin/Gradle проект с задачами `ktlintCheck`, `detekt`, `build`, `test`.
    * Включённые плагины:

        * [ktlint](https://github.com/JLLeitschuh/ktlint-gradle)
        * [detekt](https://detekt.dev/)
    * Рабочий Gradle Wrapper (`./gradlew`)

3. **Зависимости для spellcheck:**

    * `yaspeller` (ставится автоматически через npm в CI/CD).

4. **Включённая защита веток на GitHub (Branch protection):**

    * Запретить прямой push в ветки `master`, `develop`, `release/*`.
    * Требовать прохождения всех статус-чеков перед merge.

5. **Настроенный шаблон PR-именования.**

    * Документировать для команды.

---

## Как пользоваться

### 1. Обычный рабочий процесс (рекомендованный):

* **Любые изменения делаются в feature-ветке.**
* **Создаёте Pull Request** в одну из защищённых веток (`master`, `develop`, `release/*`).
* **Пайплайн стартует автоматически.**
* Если название PR не соответствует шаблону — получите ошибку сразу.
* Если есть ошибки линтера, статического анализа, орфографии, сборки или тестов — пайплайн остановится на первом из них.
* Если все этапы зелёные — Pull Request можно сливать в защищённую ветку.

### 2. Запуск вручную

* Можно запустить пайплайн из интерфейса Actions через `workflow_dispatch` (например, для ручной проверки или отладки).

### 3. Добавление новых проверок

* Просто добавляйте новые jobs в `.github/workflows/ci.yml` и при необходимости подключайте к ним артефакты через upload/download.
* Shared setup можно расширять или выносить в приватный/public action при росте команды.

### 4. Работа с артефактами

* После успешной сборки, артефакты доступны для скачивания в разделе Actions → Build → Artifacts.
* Их можно использовать для деплоя, интеграционных тестов, ручного анализа.

---

## Советы и рекомендации

* **Поддерживайте актуальность линтеров и стат-анализаторов.**
* **Регулярно пересматривайте и расширяйте шаблон имени PR под задачи команды.**
* **Используйте отдельные jobs для новых типов проверок — это ускоряет работу CI/CD.**
* **Интегрируйте Codecov или аналоги для покрытия тестами — при необходимости.**
* **Для крупных команд — заводите общий `.editorconfig`, `detekt.yml` и другие shared-конфиги.**

---

## Пример команды для запуска локально

```sh
./gradlew ktlintCheck detekt build test
```

---

## Вопросы и поддержка

* Если CI/CD не стартует, проверьте структуру `.github` и имена файлов.
* Если шаги падают — посмотрите логи в Actions, уточните конфиги `build.gradle.kts`, плагины и зависимости.
* Для расширения пайплайна — обратитесь к документации GitHub Actions или \[напишите ответственному за автоматизацию].

---

**CI/CD — основа надёжности и стабильности вашего проекта.
Настраивайте, улучшайте и автоматизируйте процесс — и качество релизов будет на высоте!**
