name: CI

on:
  pull_request:
    branches:
      - "master"
      - "develop"
      - "release/*"
  workflow_dispatch:

jobs:
  check-mr-naming:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate MR title by convention
        env:
          MR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [[ ! "$MR_TITLE" =~ ^[a-zA-Z0-9_-]+[[:space:]]*\|[[:space:]]*[a-zA-Z0-9_-]+[[:space:]]*\|[[:space:]]*(feature|fix|chore|refactor|docs|perf)[[:space:]]*\|[[:space:]]*#[0-9]+[[:space:]]*-[[:space:]]+.+$ ]]; then
            echo "❌ Invalid MR title: $MR_TITLE"
            echo "Example: backend | user-auth | feature | #1234 - implement JWT login"
            exit 1
          fi
          echo "✔ MR title is valid: $MR_TITLE"

      - name: Upload source as artifact
        uses: actions/upload-artifact@v4
        with:
          name: source
          path: .

  lint:
    runs-on: ubuntu-latest
    needs: check-mr-naming
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/shared-setup
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Run linter (ktlint)
        run: ./gradlew ktlintCheck

  static-analysis:
    runs-on: ubuntu-latest
    needs: check-mr-naming
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/shared-setup
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Run static analysis (detekt)
        run: ./gradlew detekt

  spellcheck:
    runs-on: ubuntu-latest
    needs: check-mr-naming
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/shared-setup
      - name: Run spellcheck (yaspeller)
        run: |
          npm install -g yaspeller
          yaspeller --lang ru,en --ignore-uppercase --file-extensions ".kt,.kts,.md,.txt" .

  build:
    runs-on: ubuntu-latest
    needs: [lint, static-analysis, spellcheck]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/shared-setup
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Build with Gradle
        run: ./gradlew build --no-daemon
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/libs/**/*.jar
            build/libs/**/*.war

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/shared-setup
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./build/libs
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      - name: Run tests
        run: ./gradlew test --no-daemon
